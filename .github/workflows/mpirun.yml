name: Testing mpirun

on:
  workflow_dispatch:

jobs:
  Testing_Mpi:
    runs-on: ubuntu-22.04
    steps:
      - name: Install MPI
        run: sudo apt-get update && sudo apt-get install -y mpich
      - name: Check if mpirun is available
        run: which mpirun || echo "mpirun not found"
      - name: Checkout
        uses: actions/checkout@v5
      - name: Install Conda
        uses: conda-incubator/setup-miniconda@v3
        with:
          mamba-version: "*"
          channels: conda-forge
          channel-priority: "true"
          conda-remove-defaults: "true"
      - name: Install Deps
        shell: bash -el {0}
        run: |
          conda create -y -n test_karabo python=3.10
          conda activate test_karabo
          conda env update -f environment.yaml
      - name: Test Code
        shell: bash -l {0}
        run: |
          conda activate test_karabo
          python --version
          export IS_GITHUB_RUNNER=true RUN_GPU_TESTS=false RUN_NOTEBOOK_TESTS=true
          mpirun
